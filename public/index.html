<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Live Platform</title>
  <link rel="stylesheet" href="style-modern.css">

  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <!-- å·¦å´é¸å–® -->
    <aside class="sidebar">
      <div class="profile-section">
        <img id="avatar" src="https://cdn-icons-png.flaticon.com/512/1946/1946429.png" alt="Avatar">
        <h3 id="username">ä½¿ç”¨è€…åç¨±</h3>
        <button id="editProfile">ç·¨è¼¯å€‹äººè³‡æ–™</button>
      </div>
      <hr />
      <button id="startLive">ğŸ¥ é–‹å§‹ç›´æ’­</button>
      <button id="logout">ğŸšª ç™»å‡º</button>
    </aside>

    <!-- ç·¨è¼¯å€‹äººè³‡æ–™å½ˆçª— -->
    <div id="profileModal" class="modal hidden">
      <div class="modal-content">
        <h2>ç·¨è¼¯å€‹äººè³‡æ–™</h2>
        <form id="profileForm">
          <label>ä½¿ç”¨è€…åç¨±</label><br>
          <input type="text" name="username" placeholder="æ–°çš„ä½¿ç”¨è€…åç¨±" required><br><br>

          <label>æ€§åˆ¥</label><br>
          <select name="gender" id="profileGender">
            <option value="ä¸é€éœ²">ä¸é€éœ²</option>
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select><br><br>

          <label>å¹´é½¡</label><br>
          <input type="number" name="age" id="profileAge" min="0" max="120" placeholder="ä¾‹å¦‚ï¼š25"><br><br>

          <label>é ­åƒï¼ˆæ–¹å½¢ 1:1ï¼‰</label><br>
          <input type="file" id="profileAvatarInput" accept="image/*"><br>
          <div style="text-align:center;margin-top:8px;">
            <img id="profileAvatarPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect fill='%23e0e0e0' width='200' height='200'/%3E%3Ccircle cx='100' cy='70' r='40' fill='%23999'/%3E%3Cellipse cx='100' cy='150' rx='50' ry='40' fill='%23999'/%3E%3C/svg%3E" alt="avatar" style="width:96px;height:96px;object-fit:cover;border-radius:8px;border:1px solid #ccc;display:block;margin:8px auto;">
          </div>

          <div style="margin-top:12px;">
            <button type="submit">å„²å­˜è®Šæ›´</button>
            <button type="button" id="closeProfile">å–æ¶ˆ</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const profileModal = document.getElementById('profileModal');
      document.getElementById('editProfile').onclick = () => profileModal.classList.remove('hidden');
      document.getElementById('closeProfile').onclick = () => profileModal.classList.add('hidden');
      // NOTE: profile form submit handler is attached later after fetching profile to avoid duplicate listeners.
    </script>

    <!-- ä¸»è¦–å€ -->
    <main class="main-content">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="è¼¸å…¥æˆ¿é–“è™Ÿä»¥åŠ å…¥ç›´æ’­">
        <button id="searchBtn">æœå°‹</button>
      </div>
      <h2>
        ğŸ”¥ ç†±é–€ç›´æ’­
        <button id="refreshBtn" style="margin-left:10px;padding:5px 10px;border:none;background:#2196F3;color:white;border-radius:4px;cursor:pointer;transition:all 0.3s ease;">
          ğŸ”„ é‡æ–°æ•´ç†
        </button>
      </h2>
      <div id="streamList" class="stream-grid">
        <p>ç›®å‰æ²’æœ‰æ­£åœ¨é€²è¡Œçš„ç›´æ’­</p>
      </div>
    </main>
  </div>

  <!-- ç›´æ’­è¨­å®šå½ˆçª— -->
  <div id="liveModal" class="modal hidden">
    <div class="modal-content large">
      <h2>è¨­å®šç›´æ’­è³‡è¨Š</h2>
      <form id="liveForm">
        <label>ç›´æ’­é–“åç¨±</label><br>
        <input type="text" name="title" required><br><br>
        <label>ç›´æ’­ç°¡ä»‹</label><br>
        <textarea name="description" placeholder="ä»‹ç´¹ä¸€ä¸‹ä½ çš„ç›´æ’­ï½"></textarea><br><br>
        <label>Hashtagï¼ˆè«‹ä»¥#é–‹é ­ï¼Œç©ºæ ¼åˆ†éš”ï¼‰</label><br>
        <input type="text" name="hashtags" placeholder="#éŸ³æ¨‚ #æ•™å­¸"><br><br>
        <label>å°é¢åœ–</label><br>
        <input type="file" id="coverInput"><br><br>
        <button type="submit">é–‹å§‹ç›´æ’­</button>
        <button type="button" id="closeModal">å–æ¶ˆ</button>
      </form>
    </div>
  </div>


  <script>

    document.addEventListener('DOMContentLoaded', () => {
      // --- åˆå§‹è¨­å®š ---
      const socket = io();  // åˆå§‹åŒ– Socket.IO é€£æ¥
      const usernameEl = document.getElementById('username');
      const liveModal = document.getElementById('liveModal');
      const coverInput = document.getElementById('coverInput');

      // å–å¾—å€‹äººè³‡æ–™
      fetch('/api/profile', {
        method: 'GET',
        credentials: 'include'  // âœ… åŠ é€™è¡Œï¼
      })
        .then(res => {
          if (!res.ok) throw new Error('unauthorized');
          return res.json();
        })
        .then(user => {
          usernameEl.textContent = user.username;
          // å·¦å´é ­åƒèˆ‡åç¨±
          const avatarImg = document.getElementById('avatar');
          avatarImg.src = (user.avatar || '/uploads/default_avatar.png') + '?t=' + Date.now();

          // é å¡« profile modal æ¬„ä½
          const profileNameInput = document.querySelector('#profileForm input[name="username"]');
          const profileGender = document.getElementById('profileGender');
          const profileAvatarPreview = document.getElementById('profileAvatarPreview');
          const profileAvatarInput = document.getElementById('profileAvatarInput');

          if (profileNameInput) profileNameInput.value = user.username || '';
          if (profileGender) profileGender.value = user.gender || 'ä¸é€éœ²';
          const profileAgeInput = document.getElementById('profileAge');
          if (profileAgeInput) profileAgeInput.value = (user.age !== undefined && user.age !== null) ? user.age : '';
          if (profileAvatarPreview) profileAvatarPreview.src = user.avatar || '/uploads/default_avatar.png';

          // é ­åƒé è¦½
          if (profileAvatarInput) {
            profileAvatarInput.addEventListener('change', () => {
              const f = profileAvatarInput.files[0];
              if (!f) {
                profileAvatarPreview.src = user.avatar || '/uploads/default_avatar.png';
                return;
              }
              profileAvatarPreview.src = URL.createObjectURL(f);
            });
          }

          // Profile è¡¨å–®é€å‡ºï¼šå…ˆæ›´æ–° username/genderï¼Œç„¶å¾Œï¼ˆè‹¥æœ‰ï¼‰ä¸Šå‚³é ­åƒ
          const profileForm = document.getElementById('profileForm');
          if (profileForm) {
            profileForm.addEventListener('submit', async ev => {
              ev.preventDefault();
              const values = Object.fromEntries(new FormData(profileForm));
              try {
                const res = await fetch('/api/update-profile', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ username: values.username, gender: values.gender, age: values.age || null })
                });
                const resp = await res.json();
                alert(resp.message || 'å·²æ›´æ–°å€‹äººè³‡æ–™');

                // è‹¥æœ‰æ–°é ­åƒå‰‡ä¸Šå‚³
                if (profileAvatarInput && profileAvatarInput.files && profileAvatarInput.files.length > 0) {
                  const fd = new FormData();
                  fd.append('avatar', profileAvatarInput.files[0]);
                  try {
                    const up = await fetch('/api/upload-avatar', {
                      method: 'POST',
                      credentials: 'include',
                      body: fd
                    });
                    const upJson = await up.json();
                    if (!up.ok) console.warn('ä¸Šå‚³é ­åƒå¤±æ•—ï¼š', upJson);
                  } catch (err) {
                    console.error('ä¸Šå‚³é ­åƒéŒ¯èª¤ï¼š', err);
                  }
                }

                // æ›´æ–°å·¦å´é¡¯ç¤ºä¸¦é—œé–‰ modal
                // é‡æ–°å–å¾— profile ä¸¦æ›´æ–° UI
                const fresh = await fetch('/api/profile', { credentials: 'include' });
                if (fresh.ok) {
                  const newUser = await fresh.json();
                  usernameEl.textContent = newUser.username;
                  // cache-bust to ensure new avatar is fetched
                  avatarImg.src = (newUser.avatar || '/uploads/default_avatar.png') + '?t=' + Date.now();
                }

                document.getElementById('profileModal').classList.add('hidden');
              } catch (err) {
                console.error('æ›´æ–°å€‹äººè³‡æ–™å¤±æ•—ï¼š', err);
                alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
              }
            });
          }
        })
        .catch(() => {
          location.href = '/login.html';
        });


        // ========== ç†±é–€ç›´æ’­æ¸…å–®è¼‰å…¥ + è‡ªå‹•åˆ·æ–° ==========
        async function loadStreams(isManualRefresh = false) {
          const refreshBtn = document.getElementById('refreshBtn');
          const streamList = document.getElementById('streamList');
          
          if (isManualRefresh) {
            refreshBtn.classList.add('refreshing');
            refreshBtn.disabled = true;
            streamList.style.opacity = '0.7';
          }

          try {
            const res = await fetch('/api/streams');
            const streams = await res.json();

            // æ·»åŠ æ·¡å…¥æ•ˆæœ
            streamList.style.opacity = '0';
            
            if (streams.length === 0) {
              streamList.innerHTML = "<p>ç›®å‰æ²’æœ‰æ­£åœ¨é€²è¡Œçš„ç›´æ’­</p>";
            } else {
              streamList.innerHTML = streams.map(s => {
                // detect PK rooms: check if room_id starts with 'PK_' or contains '_PK_' (legacy)
                // or the title contains PK indicators
                const roomIdStr = String(s.room_id);
                const isPK = roomIdStr.startsWith('PK_') || roomIdStr.includes('_PK_') || (s.title && (String(s.title).includes('PKå°æ±º') || String(s.title).includes('ğŸ”¥')));
                const href = isPK ? `/pk-viewer.html?room=${s.room_id}` : `/viewer.html?room=${s.room_id}`;
                const badge = isPK ? `<span style="color:#fff;background:#d32f2f;padding:4px 8px;border-radius:6px;margin-left:8px;font-size:12px;">PK</span>` : '';
                return `
                <div class="stream-card">
                  <img src="${s.cover || 'https://cdn-icons-png.flaticon.com/512/1160/1160358.png'}?t=${Date.now()}" 
                      alt="cover" 
                      style="aspect-ratio:16/9;object-fit:cover;border-radius:8px;background:#000;">
                  <h3>${s.title} ${badge}</h3>
                  <p>ğŸ‘¤ ${s.username}</p>
                  <p>${s.description}</p>
                  <a href="${href}" class="view-btn">å‰å¾€è§€çœ‹</a>
                </div>
              `}).join('');
            }

            // Attach robust click handlers to view buttons to ensure navigation works
            // (some browsers or overlays may block native <a> navigation; use JS fallback)
            setTimeout(() => {
              const btns = streamList.querySelectorAll('.view-btn');
              btns.forEach(b => {
                b.addEventListener('click', (ev) => {
                  try { ev.preventDefault(); } catch (e) {}
                  const href = b.getAttribute('href');
                  console.log('[index] navigate to', href);
                  if (href) window.location.href = href;
                });
              });
              // Make the whole card clickable and keyboard-accessible
              const cards = streamList.querySelectorAll('.stream-card');
              cards.forEach(card => {
                try {
                  card.setAttribute('tabindex', '0');
                  card.setAttribute('role', 'link');
                  card.style.cursor = 'pointer';

                  const navigateFromCard = () => {
                    const a = card.querySelector('.view-btn');
                    if (!a) return;
                    const href = a.getAttribute('href');
                    if (href) {
                      console.log('[index] card navigate to', href);
                      window.location.href = href;
                    }
                  };

                  card.addEventListener('click', (ev) => {
                    // if user clicked an interactive element inside (like a link/button), still navigate via href
                    navigateFromCard();
                  });

                  card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                      e.preventDefault();
                      navigateFromCard();
                    }
                  });
                } catch (ex) {
                  // ignore per-card errors
                }
              });
            }, 0);

            // æ·¡å…¥é¡¯ç¤º
            setTimeout(() => {
              streamList.style.opacity = '1';
            }, 100);

          } catch (err) {
            console.error("âŒ ç„¡æ³•è¼‰å…¥ç›´æ’­æ¸…å–®ï¼š", err);
            alert("è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
          } finally {
            if (isManualRefresh) {
              setTimeout(() => {
                refreshBtn.classList.remove('refreshing');
                refreshBtn.disabled = false;
                streamList.style.opacity = '1';
              }, 500);
            }
          }
        }

        // é¦–æ¬¡è¼‰å…¥
        loadStreams();

        // ğŸ”„ æ‰‹å‹•åˆ·æ–°æŒ‰éˆ•
        document.getElementById('refreshBtn').onclick = () => loadStreams(true);

        // â± æ¯ 10 ç§’è‡ªå‹•åˆ·æ–°ä¸€æ¬¡
        setInterval(loadStreams, 10000);
        
        // ç›£è½å°é¢æ›´æ–°äº‹ä»¶
        socket.on("cover-updated", () => loadStreams());


      // é–‹ç›´æ’­æŒ‰éˆ•
      document.getElementById('startLive').onclick = () => liveModal.classList.remove('hidden');
      document.getElementById('closeModal').onclick = () => liveModal.classList.add('hidden');

      // ç™»å‡º
      document.getElementById('logout').onclick = async () => {
        await fetch('/api/logout', { method: 'POST' });
        location.href = '/login.html';
      };

      // é–‹å§‹ç›´æ’­è¡¨å–®ï¼šå…ˆå»ºç«‹ streamï¼Œå†ï¼ˆé¸æ“‡æ€§ï¼‰ä¸Šå‚³å°é¢æª”æ¡ˆåˆ°ä¼ºæœå™¨
      document.getElementById('liveForm').onsubmit = async e => {
        e.preventDefault();
        const formValues = Object.fromEntries(new FormData(e.target));
        const coverFile = coverInput.files[0];

        // 1) å»ºç«‹ç›´æ’­é–“ï¼ˆä¸ç›´æ¥å‚³ blob URLï¼‰
        const res = await fetch('/api/start-stream', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...formValues })
        });
        const data = await res.json();
        alert(data.message);
        if (!res.ok) return;

        const roomId = data.roomId;

        // 2) è‹¥æœ‰ä¸Šå‚³å°é¢æª”æ¡ˆï¼Œä½¿ç”¨ /api/upload-cover ä¸Šå‚³ï¼ˆæœƒå„²å­˜åœ¨ uploads/<roomId>/cover.ext ä¸¦æ›´æ–°è³‡æ–™åº«ï¼‰
        if (coverFile) {
          try {
            const fd = new FormData();
            // append roomId first so multer can read it during storage
            fd.append('roomId', roomId);
            fd.append('cover', coverFile);
            const up = await fetch('/api/upload-cover', {
              method: 'POST',
              credentials: 'include',
              body: fd
            });
            const upData = await up.json();
            if (!up.ok) console.warn('å°é¢ä¸Šå‚³å¤±æ•—ï¼š', upData);
          } catch (err) {
            console.error('ä¸Šå‚³å°é¢ç™¼ç”ŸéŒ¯èª¤ï¼š', err);
          }
        }

        // 3) å°å‘ä¸»æ’­é é¢
        location.href = `/broadcaster.html?room=${roomId}`;
      };

      // æœå°‹åŠŸèƒ½ï¼ˆæŒ‰éˆ•èˆ‡ Enterï¼‰
      const searchInput = document.getElementById('searchInput');
      const searchBtn = document.getElementById('searchBtn');
      function goToRoom() {
        const code = (searchInput.value || '').trim();
        if (!code) return alert('è«‹è¼¸å…¥æˆ¿é–“è™Ÿ');
        // Auto-detect PK rooms and redirect to pk-viewer
        const isPKRoom = code.startsWith('PK_') || code.includes('_PK_');
        const targetPage = isPKRoom ? '/pk-viewer.html' : '/viewer.html';
        window.location.href = `${targetPage}?room=${encodeURIComponent(code)}`;
      }
      if (searchBtn) searchBtn.onclick = goToRoom;
      if (searchInput) searchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); goToRoom(); }
      });
    });
  </script>
</body>
</html>
